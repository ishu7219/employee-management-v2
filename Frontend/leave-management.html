<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leave Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="leave-management.css">
</head>
<body>
  <div class="sidebar">
    <!-- Sidebar content stays unchanged -->
    <div class="sidebar-logo-row">
      <div class="sidebar-squares">
        <div class="sq1"></div>
        <div class="sq2"></div>
        <div class="sq3"></div>
        <div class="sq4"></div>
      </div>
      <span class="sidebar-title">ADMIN PANEL</span>
    </div>
    <nav class="flex-column">
      <a href="user-management.html" class="nav-link"><i class="fa fa-users"></i> User Management</a>
      <a href="system-management.html" class="nav-link"><i class="fa fa-sliders-h"></i> Salary management</a>
      <a href="leave-management.html" class="nav-link active"><i class="fa fa-calendar-xmark"></i> Leave management</a>
      <a href="calendar.html" class="nav-link"><i class="fa fa-calendar-day"></i> Calendar</a>
      <a href="settings.html" class="nav-link"><i class="fa fa-gear"></i> Settings</a>
    </nav>
  </div>
  <div class="main-panel">
    <div class="header-row">
      <h3 style="font-weight:600;">Leave management</h3>
      <nav aria-label="breadcrumb" style="--bs-breadcrumb-divider: '>';">
        <ol class="breadcrumb small">
          <li class="breadcrumb-item">Home</li>
          <li class="breadcrumb-item active" aria-current="page">Leave</li>
        </ol>
      </nav>
    </div>
    <div class="admin-manager-card">
      <label style="font-weight:500;">Search</label>
      <div class="search-row mt-2">
        <label style="color:#555;">Search by leave type</label>
        <input type="text" id="searchLeaveType" placeholder="Leave type"/>
        <button class="btn btn-success" onclick="searchLeaves()">Search</button>
        <button class="btn btn-danger" onclick="clearLeaveSearch()">Clear</button>
      </div>
    </div>
    <!-- Add Leave Request Form -->
    <div style="margin-bottom: 25px;">
      <form id="addLeaveForm" class="row g-3 align-items-end">
        <div class="col-auto">
          <label class="form-label">Employee</label>
          <select class="form-select" id="leaveEmployee" required>
            <!-- populated by JS -->
          </select>
        </div>
        <div class="col-auto">
          <label class="form-label">Type</label>
          <input type="text" id="leaveType" class="form-control" required>
        </div>
        <div class="col-auto">
          <label class="form-label">From</label>
          <input type="date" id="leaveFrom" class="form-control" required>
        </div>
        <div class="col-auto">
          <label class="form-label">To</label>
          <input type="date" id="leaveTo" class="form-control" required>
        </div>
        <div class="col-auto">
          <label class="form-label">Days</label>
          <input type="number" min="1" id="leaveDays" class="form-control" required>
        </div>
        <div class="col-auto">
          <label class="form-label">Reason</label>
          <input type="text" id="leaveReason" class="form-control" required>
        </div>
        <div class="col-auto">
          <label class="form-label">Offer</label>
          <select id="leaveOffer" class="form-select" required>
            <option value="Paid">Paid</option>
            <option value="Unpaid">Unpaid</option>
          </select>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary">Add Leave</button>
        </div>
      </form>
    </div>
    <div class="table-box">
      <label style="font-weight:500; margin-bottom:7px;">Leave List</label>
      <table class="table table-bordered align-middle">
        <thead>
          <tr>
            <th>S.N</th>
            <th>Employee name</th>
            <th>Leave type</th>
            <th>Date from</th>
            <th>Date to</th>
            <th>No. of days</th>
            <th>Reason</th>
            <th>Leave type offer</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="leaveTableBody"></tbody>
      </table>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let leaves = [];
    let employees = [];

    async function fetchEmployees() {
      const res = await fetch('http://localhost:3000/api/users');
      employees = await res.json();
      const select = document.getElementById('leaveEmployee');
      select.innerHTML = employees.map(emp => `<option value="${emp.id}">${emp.username}</option>`).join('');
    }

    async function fetchLeaves(filterType = "") {
      const res = await fetch('http://localhost:3000/api/leaves');
      let data = await res.json();
      if (filterType) {
        data = data.filter(lv => lv.leave_type.toLowerCase().includes(filterType.toLowerCase()));
      }
      leaves = data;
      renderLeaveTable();
    }

    function renderLeaveTable() {
      const tbody = document.getElementById('leaveTableBody');
      tbody.innerHTML = '';
      leaves.forEach((lv, idx) => {
        tbody.innerHTML += `
          <tr>
            <td>${idx + 1}</td>
            <td>${lv.employee_name}</td>
            <td>${lv.leave_type}</td>
            <td>${lv.date_from}</td>
            <td>${lv.date_to}</td>
            <td>${lv.days}</td>
            <td>${lv.reason}</td>
            <td>
              <span class="badge ${lv.leave_type_offer === 'Paid' ? 'bg-info text-dark' : 'bg-danger'}">${lv.leave_type_offer}</span>
            </td>
            <td>${lv.status}</td>
            <td>
              <button class="btn btn-success btn-sm me-1" onclick="updateStatus(${lv.id}, 'Approved')" ${lv.status === 'Approved' ? 'disabled' : ''}>Approve</button>
              <button class="btn btn-danger btn-sm" onclick="updateStatus(${lv.id}, 'Rejected')" ${lv.status === 'Rejected' ? 'disabled' : ''}>Reject</button>
            </td>
          </tr>`;
      });
    }

    function searchLeaves() {
      const type = document.getElementById('searchLeaveType').value.trim();
      fetchLeaves(type);
    }

    function clearLeaveSearch() {
      document.getElementById('searchLeaveType').value = '';
      fetchLeaves();
    }

    async function updateStatus(id, newStatus) {
      await fetch(`http://localhost:3000/api/leaves/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      });
      fetchLeaves();
    }

    document.getElementById('addLeaveForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      const employee_id = document.getElementById('leaveEmployee').value;
      const leave_type = document.getElementById('leaveType').value.trim();
      const date_from = document.getElementById('leaveFrom').value;
      const date_to = document.getElementById('leaveTo').value;
      const days = Number(document.getElementById('leaveDays').value);
      const reason = document.getElementById('leaveReason').value.trim();
      const leave_type_offer = document.getElementById('leaveOffer').value;
      await fetch('http://localhost:3000/api/leaves', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ employee_id, leave_type, date_from, date_to, days, reason, leave_type_offer })
      });
      fetchLeaves();
      event.target.reset();
    });

    // Initial load
    fetchEmployees().then(fetchLeaves);
  </script>
</body>
</html>
